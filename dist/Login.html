<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-beta1/css/bootstrap.min.css" rel="stylesheet"> -->
    <title>Login</title>
  </head>
  <body>
    <h2>Login page</h2>

    <form class="register">
        <h2>Login page</h2>
              <label for="email">Email:</label>
      <input type="text" name="email" id="emailInp" required />
      <label for="password">Password:</label>
      <input type="password" name="password" id="passwordInp" required />

      <button type="submit" class="btn btn-primary">Login</button>
      <a href="../dist/Register.html">
        <button type="button" class="btn btn-primary">Sign Up</button>
      </a>
    </form>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="./bundle.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script> -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
      import {
        getDatabase,
        get,
        ref,
        child
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBmno2mvP8YTKKlBdcBb6pPn3l5cb8pKJA",
        authDomain: "splash-wash-f27d8.firebaseapp.com",
        projectId: "splash-wash-f27d8",
        storageBucket: "splash-wash-f27d8.appspot.com",
        messagingSenderId: "1072800525434",
        appId: "1:1072800525434:web:7b423933d321c7e963dfc3",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);
      const dbref = ref(db);

      let EmailInp = $("#emailInp");
      let PassInp = $("#passwordInp");
      let MainForm = $(".register");

      let LoginUser = (event) => {
        event.preventDefault();

        signInWithEmailAndPassword(auth, EmailInp.val(), PassInp.val())
          .then((credential) => {
            get(child(dbref, `users/${credential.user.uid}`))
              .then((snapshot) => {
                if (snapshot.exists()) {
                  alert("User logged in");
                  sessionStorage.setItem("user-info", JSON.stringify({
                    firstname: snapshot.val().firstname,
                    lastname: snapshot.val().lastname 
                }));
                sessionStorage.setItem("user-creds", JSON.stringify({
                    email: EmailInp.val(),
                    password: PassInp.val()}));
                  window.location.href = "../dist/Home.html";
                } else {
                  alert("User not found");
                }
              })
              .catch((error) => {
                alert(error.message);
                console.log(error.message);
                console.log(error.code);
              });
          })
          .catch((error) => {
            alert(error.message);
            console.log(error.message);
            console.log(error.code)
          });
      };

      console.log(LoginUser);
      MainForm.on("submit", LoginUser);
    </script>
  </body>
</html>